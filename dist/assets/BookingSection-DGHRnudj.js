import{j as e,r as x}from"./react-C1G-q6RG.js";import{b as Q,u as W}from"./index-VDPl71_X.js";import{A as X}from"./firebase-CpY9aKCX.js";import{f as Z}from"./firebase-functions-ByRxjYJr.js";import{k as _,l as U,m as ee,C as te,n as se,o as ae}from"./icons-DJqNYe3e.js";const re=({value:a,onChange:r,min:l=1,max:o})=>{const n=()=>{const p=a+1;(o===void 0||p<=o)&&r(p)},s=()=>{const p=a-1;(l===void 0||p>=l)&&r(p)},g=p=>{const b=parseInt(p.target.value.replace(/[^0-9]/g,""),10);isNaN(b)?p.target.value===""&&r(l):(l===void 0||b>=l)&&(o===void 0||b<=o)?r(b):l!==void 0&&b<l&&r(l)};return e.jsxs("div",{className:"relative flex items-center",children:[e.jsx("input",{type:"text",inputMode:"numeric",pattern:"[0-9]*",value:a,onChange:g,className:"w-full p-3 border border-gray-200 rounded-xl text-center"}),e.jsxs("div",{className:"absolute right-2 flex flex-col",children:[e.jsx("button",{type:"button",onClick:n,className:"p-1 text-gray-500 hover:text-gray-800",children:e.jsx(_,{className:"w-4 h-4"})}),e.jsx("button",{type:"button",onClick:s,className:"p-1 text-gray-500 hover:text-gray-800",children:e.jsx(U,{className:"w-4 h-4"})})]})]})},ne=X(Z,"createBooking"),le=x.memo(({status:a})=>{const r={approved:{text:"승인됨 / Approved",color:"bg-green-100 text-green-800"},pending:{text:"대기중 / Pending",color:"bg-orange-100 text-orange-800"},rejected:{text:"거절됨 / Rejected",color:"bg-red-100 text-red-800"},completed:{text:"종료 / Ended",color:"bg-gray-100 text-gray-800"},cancelled:{text:"취소됨 / Cancelled",color:"bg-gray-100 text-gray-800"}},{text:l,color:o}=r[a];return e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-medium ${o}`,children:l})}),ie=["일","월","화","수","목","금","토"],oe=a=>{const{startDate:r,endDate:l,recurrenceRule:o}=a;if(r===l)return r;let n="";return o&&o.days.length>0&&(n=` (매주 / Every ${o.days.sort().map(s=>ie[s]).join(", ")})`),`${r} ~ ${l}${n}`},B=x.memo(({booking:a})=>e.jsx("div",{className:"p-3 bg-gray-50 rounded-xl transition-colors duration-200 hover:bg-gray-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:a.purpose}),e.jsxs("p",{className:"text-sm text-gray-600",children:[a.organization?`${a.organization} | `:"",oe(a)," ",a.startTime,"-",a.endTime]})]}),e.jsx(le,{status:a.status})]})})),pe=({currentUser:a,bookings:r,setBookings:l})=>{const{facilities:o}=Q(),{showNotification:n}=W(),[s,g]=x.useState({purpose:"",category:"training",numberOfParticipants:1,startDate:new Date().toISOString().split("T")[0],endDate:new Date().toISOString().split("T")[0],startTime:"09:00",endTime:"10:00",facilityId:""}),[p,b]=x.useState(!1),[w,S]=x.useState("list"),[j,T]=x.useState(new Date),k=x.useMemo(()=>r.filter(t=>t.userId===a.id&&t.status!=="completed"),[r,a.id]),I=x.useMemo(()=>r.filter(t=>t.userId===a.id&&t.status==="completed"),[r,a.id]),O=x.useCallback(()=>{const t=j.getFullYear(),m=j.getMonth(),c=new Date(t,m,1),u=new Date(c);u.setDate(u.getDate()-c.getDay());const h=[];for(let i=0;i<42;i++){const y=new Date(u);y.setDate(u.getDate()+i),h.push(y)}return h},[j]),E=x.useCallback(t=>(t.toISOString().split("T")[0],r.filter(m=>{const c=new Date(m.startDate),u=new Date(m.endDate);return t>=c&&t<=u})),[r]),$=x.useCallback(t=>{T(m=>{const c=new Date(m);return c.setMonth(m.getMonth()+(t==="next"?1:-1)),c})},[]),F=x.useCallback(async t=>{if(t.preventDefault(),!s.purpose||s.purpose.trim().length===0){n("대관 목적을 입력해주세요.","error");return}if(s.purpose.trim().length<2){n("대관 목적은 최소 2자 이상 입력해주세요.","error");return}if(!s.category||!s.startDate||!s.endDate||!s.startTime||!s.endTime){n("모든 필수 항목을 입력해주세요.","error");return}const m=new Date(s.startDate),c=new Date(s.endDate),u=new Date;if(u.setHours(0,0,0,0),m<u){n("시작일은 오늘 이후로 선택해주세요.","error");return}if(c<m){n("종료일은 시작일 이후로 선택해주세요.","error");return}if(s.startTime>=s.endTime){n("종료 시간은 시작 시간 이후로 선택해주세요.","error");return}if(!s.facilityId){n("시설을 선택해주세요.","error");return}const h=o.find(d=>d.id===s.facilityId);if(!h){n("선택된 시설을 찾을 수 없습니다.","error");return}const i=h.bookingPolicy,y=i?.allowOverlap||!1,M=i?.maxConcurrent||1,D=r.filter(d=>{if(d.facilityId!==s.facilityId||d.status!=="approved")return!1;const f=new Date(d.startDate),v=new Date(d.endDate),C=new Date(s.startDate),N=new Date(s.endDate);if(!(f<=N&&v>=C))return!1;const[P,H]=d.startTime.split(":").map(Number),[A,L]=d.endTime.split(":").map(Number),[R,V]=s.startTime.split(":").map(Number),[z,Y]=s.endTime.split(":").map(Number),G=P*60+H,q=A*60+L,J=R*60+V,K=z*60+Y;return G<K&&q>J});if(!y&&D.length>0){n("이 시설은 단독 사용만 가능합니다. 같은 시간에 다른 예약이 있어 신청할 수 없습니다.","error");return}if(y&&D.length>=M){n(`이 시설은 최대 ${M}팀까지 동시 사용 가능합니다. 현재 ${D.length}팀이 예약되어 있어 추가 신청이 불가합니다.`,"error");return}b(!0);try{const d={purpose:s.purpose,category:s.category,numberOfParticipants:s.numberOfParticipants||1,facilityId:h.id,startDate:s.startDate,endDate:s.endDate,startTime:s.startTime,endTime:s.endTime};console.log("대관 신청 요청 데이터:",d);let f,v;try{f=await ne(d),console.log("대관 신청 응답:",f),v=f?.data?.bookingId||`booking-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}catch(N){console.warn("Firebase Function 호출 실패, 로컬에서 처리:",N),v=`booking-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}n("예약 신청이 완료되었습니다. 관리자 승인 후 확정됩니다.","success");const C={id:v,...d,userId:a.id,userName:a.name,userEmail:a.email,status:"pending",createdAt:new Date};l(N=>[C,...N]),g({purpose:"",category:"training",numberOfParticipants:1,startDate:new Date().toISOString().split("T")[0],endDate:new Date().toISOString().split("T")[0],startTime:"09:00",endTime:"10:00",facilityId:""})}catch(d){const f=d?.message||"예약 실패: 알 수 없는 오류";n(f,"error")}finally{b(!1)}},[s,o,n,a,l]);return e.jsxs("div",{className:"max-w-6xl mx-auto p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"체육관 대관 / Gym Booking"}),e.jsx("p",{className:"text-gray-600",children:"체육관 공간을 예약하고 관리하세요 / Book and manage gym spaces"})]}),e.jsxs("div",{className:"flex items-center gap-2 bg-gray-100 p-1 rounded-lg",children:[e.jsxs("button",{onClick:()=>S("list"),className:`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${w==="list"?"bg-white text-blue-600 shadow-sm":"text-gray-600 hover:text-gray-900"}`,children:[e.jsx(ee,{className:"w-4 h-4"}),"목록 / List"]}),e.jsxs("button",{onClick:()=>S("calendar"),className:`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${w==="calendar"?"bg-white text-blue-600 shadow-sm":"text-gray-600 hover:text-gray-900"}`,children:[e.jsx(te,{className:"w-4 h-4"}),"캘린더 / Calendar"]})]})]}),w==="list"?e.jsx(e.Fragment,{children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border border-gray-100 p-6",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"진행중인 대관 / Active Bookings"}),e.jsxs("div",{className:"space-y-3",children:[k.map(t=>e.jsx(B,{booking:t},t.id)),k.length===0&&e.jsx("p",{className:"text-center text-gray-500 py-10",children:"진행중인 대관 신청이 없습니다."})]})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border border-gray-100 p-6",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"완료된 대관 / Completed Bookings"}),e.jsxs("div",{className:"space-y-3 max-h-96 overflow-y-auto pr-2",children:[I.map(t=>e.jsx(B,{booking:t},t.id)),I.length===0&&e.jsx("p",{className:"text-center text-gray-500 py-10",children:"완료된 대관이 없습니다."})]})]})]})}):e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border border-gray-100 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-900",children:[j.getFullYear(),"년 ",j.getMonth()+1,"월"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>$("prev"),className:"p-2 rounded-lg hover:bg-gray-100 transition-colors",children:e.jsx(se,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>T(new Date),className:"px-4 py-2 text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors",children:"오늘"}),e.jsx("button",{onClick:()=>$("next"),className:"p-2 rounded-lg hover:bg-gray-100 transition-colors",children:e.jsx(ae,{className:"w-5 h-5"})})]})]}),e.jsx("div",{className:"grid grid-cols-7 gap-px mb-2",children:["일","월","화","수","목","금","토"].map(t=>e.jsx("div",{className:"p-2 text-center text-sm font-medium text-gray-500",children:t},t))}),e.jsx("div",{className:"grid grid-cols-7 gap-px bg-gray-200 rounded-lg overflow-hidden",children:O().map((t,m)=>{const c=E(t),u=t.getMonth()===j.getMonth(),h=t.toDateString()===new Date().toDateString();return e.jsxs("div",{className:`bg-white p-2 min-h-[120px] ${u?"text-gray-900":"text-gray-400"} ${h?"bg-blue-50":""}`,children:[e.jsx("div",{className:`text-sm font-medium mb-1 ${h?"text-blue-600":""}`,children:t.getDate()}),e.jsxs("div",{className:"space-y-1",children:[c.slice(0,3).map(i=>e.jsx("div",{className:`text-xs px-2 py-1 rounded text-white text-center truncate ${i.status==="approved"?"bg-green-500":i.status==="pending"?"bg-orange-500":i.status==="rejected"?"bg-red-500":"bg-gray-500"}`,title:`${i.purpose} (${i.startTime}-${i.endTime})`,children:i.purpose},i.id)),c.length>3&&e.jsxs("div",{className:"text-xs text-gray-500 text-center",children:["+",c.length-3," more"]})]})]},m)})}),e.jsxs("div",{className:"flex items-center justify-center gap-6 mt-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-green-500 rounded"}),e.jsx("span",{children:"승인됨"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-orange-500 rounded"}),e.jsx("span",{children:"대기중"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-red-500 rounded"}),e.jsx("span",{children:"거절됨"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-gray-500 rounded"}),e.jsx("span",{children:"완료됨"})]})]})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border border-gray-100 p-6",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"신규 대관 신청"}),e.jsxs("form",{onSubmit:F,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"대관 목적"}),e.jsx("input",{type:"text",className:"w-full p-3 border border-gray-200 rounded-xl",value:s.purpose||"",onChange:t=>g({...s,purpose:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"분류"}),e.jsxs("select",{className:"w-full p-3 border border-gray-200 rounded-xl bg-white",value:s.category,onChange:t=>g({...s,category:t.target.value}),children:[e.jsx("option",{value:"training",children:"훈련"}),e.jsx("option",{value:"class",children:"수업"}),e.jsx("option",{value:"event",children:"행사"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"시설 선택"}),e.jsxs("select",{className:"w-full p-3 border border-gray-200 rounded-xl bg-white",value:s.facilityId||"",onChange:t=>g({...s,facilityId:t.target.value}),children:[e.jsx("option",{value:"",children:"시설을 선택해 주세요"}),o.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsx("div",{})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"시작일"}),e.jsx("input",{type:"date",className:"w-full p-3 border border-gray-200 rounded-xl",value:s.startDate||"",onChange:t=>g({...s,startDate:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"종료일"}),e.jsx("input",{type:"date",className:"w-full p-3 border border-gray-200 rounded-xl",value:s.endDate||"",onChange:t=>g({...s,endDate:t.target.value})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"시작 시간"}),e.jsx("input",{type:"time",className:"w-full p-3 border border-gray-200 rounded-xl",value:s.startTime||"",onChange:t=>g({...s,startTime:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"종료 시간"}),e.jsx("input",{type:"time",className:"w-full p-3 border border-gray-200 rounded-xl",value:s.endTime||"",onChange:t=>g({...s,endTime:t.target.value})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"인원"}),e.jsx(re,{value:s.numberOfParticipants||1,onChange:t=>g({...s,numberOfParticipants:t})})]}),e.jsx("div",{className:"flex items-end",children:e.jsx("button",{type:"submit",disabled:p,className:"w-full md:w-auto px-4 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-medium",children:"대관 신청"})})]})]})]})]})};export{pe as default};
