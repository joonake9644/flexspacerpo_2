import{j as e,r as g}from"./react-C1G-q6RG.js";import{b as _,u as U}from"./index-JKx5WJQm.js";import{A as ee}from"./firebase-CVBrtIcl.js";import{f as te}from"./firebase-functions-ekMhbLJx.js";import{k as se,l as ae,m as re,C as ne,n as le,o as ie}from"./icons-DJqNYe3e.js";const de=({value:a,onChange:r,min:i=1,max:x})=>{const b=()=>{const l=a+1;(x===void 0||l<=x)&&r(l)},n=()=>{const l=a-1;(i===void 0||l>=i)&&r(l)},s=l=>{const p=parseInt(l.target.value.replace(/[^0-9]/g,""),10);isNaN(p)?l.target.value===""&&r(i):(i===void 0||p>=i)&&(x===void 0||p<=x)?r(p):i!==void 0&&p<i&&r(i)};return e.jsxs("div",{className:"relative flex items-center",children:[e.jsx("input",{type:"text",inputMode:"numeric",pattern:"[0-9]*",value:a,onChange:s,className:"w-full p-3 border border-gray-200 rounded-xl text-center"}),e.jsxs("div",{className:"absolute right-2 flex flex-col",children:[e.jsx("button",{type:"button",onClick:b,className:"p-1 text-gray-500 hover:text-gray-800",children:e.jsx(se,{className:"w-4 h-4"})}),e.jsx("button",{type:"button",onClick:n,className:"p-1 text-gray-500 hover:text-gray-800",children:e.jsx(ae,{className:"w-4 h-4"})})]})]})},oe=ee(te,"createBooking"),ce=g.memo(({status:a})=>{const r={approved:{text:"승인됨 / Approved",color:"bg-green-100 text-green-800"},pending:{text:"대기중 / Pending",color:"bg-orange-100 text-orange-800"},rejected:{text:"거절됨 / Rejected",color:"bg-red-100 text-red-800"},completed:{text:"종료 / Ended",color:"bg-gray-100 text-gray-800"},cancelled:{text:"취소됨 / Cancelled",color:"bg-gray-100 text-gray-800"}},{text:i,color:x}=r[a];return e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-medium ${x}`,children:i})}),me=["일","월","화","수","목","금","토"],xe=a=>{const{startDate:r,endDate:i,recurrenceRule:x}=a;if(r===i)return r;let b="";return x&&x.days.length>0&&(b=` (매주 / Every ${x.days.sort().map(n=>me[n]).join(", ")})`),`${r} ~ ${i}${b}`},O=g.memo(({booking:a})=>e.jsx("div",{className:"p-3 bg-gray-50 rounded-xl transition-colors duration-200 hover:bg-gray-100",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:a.purpose}),e.jsxs("p",{className:"text-sm text-gray-600",children:[a.organization?`${a.organization} | `:"",xe(a)," ",a.startTime,"-",a.endTime]})]}),e.jsx(ce,{status:a.status})]})})),je=({currentUser:a,bookings:r,setBookings:i,syncing:x=!1})=>{const{facilities:b}=_(),{showNotification:n}=U(),[s,l]=g.useState({purpose:"",category:"training",numberOfParticipants:1,startDate:new Date().toISOString().split("T")[0],endDate:new Date().toISOString().split("T")[0],startTime:"09:00",endTime:"10:00",facilityId:""}),[p,S]=g.useState(!1),[v,T]=g.useState("list"),[f,I]=g.useState(new Date),k=g.useMemo(()=>r.filter(t=>t.userId===a.id&&t.status!=="completed"),[r,a.id]),$=g.useMemo(()=>r.filter(t=>t.userId===a.id&&t.status==="completed"),[r,a.id]),B=g.useCallback(()=>{const t=f.getFullYear(),o=f.getMonth(),c=new Date(t,o,1),u=new Date(c);u.setDate(u.getDate()-c.getDay());const h=[];for(let m=0;m<42;m++){const j=new Date(u);j.setDate(u.getDate()+m),h.push(j)}return h},[f]),F=g.useCallback(t=>(t.toISOString().split("T")[0],r.filter(o=>{const c=new Date(o.startDate),u=new Date(o.endDate);return t>=c&&t<=u})),[r]),M=g.useCallback(t=>{I(o=>{const c=new Date(o);return c.setMonth(o.getMonth()+(t==="next"?1:-1)),c})},[]),P=g.useCallback(async t=>{t.preventDefault(),S(!0),n("대관 신청을 처리 중입니다...","info");try{if(!s.purpose||s.purpose.trim().length===0){n("대관 목적을 입력해주세요.","error");return}if(s.purpose.trim().length<2){n("대관 목적은 최소 2자 이상 입력해주세요.","error");return}if(!s.category||!s.startDate||!s.endDate||!s.startTime||!s.endTime){n("모든 필수 항목을 입력해주세요.","error");return}const o=new Date(s.startDate),c=new Date(s.endDate),u=new Date;if(u.setHours(0,0,0,0),o<u){n("시작일은 오늘 이후로 선택해주세요.","error");return}if(c<o){n("종료일은 시작일 이후로 선택해주세요.","error");return}if(s.startTime>=s.endTime){n("종료 시간은 시작 시간 이후로 선택해주세요.","error");return}if(!s.facilityId){n("시설을 선택해주세요.","error");return}const h=b.find(d=>d.id===s.facilityId);if(!h){n("선택된 시설을 찾을 수 없습니다.","error");return}const m=h.bookingPolicy,j=m?.allowOverlap||!1,E=m?.maxConcurrent||1,N=r.filter(d=>{if(d.facilityId!==s.facilityId||d.status!=="approved")return!1;const C=new Date(d.startDate),y=new Date(d.endDate),A=new Date(s.startDate),L=new Date(s.endDate);if(!(C<=L&&y>=A))return!1;const[R,V]=d.startTime.split(":").map(Number),[z,Y]=d.endTime.split(":").map(Number),[G,q]=s.startTime.split(":").map(Number),[J,K]=s.endTime.split(":").map(Number),Q=R*60+V,W=z*60+Y,X=G*60+q,Z=J*60+K;return Q<Z&&W>X});if(!j&&N.length>0){n("이 시설은 단독 사용만 가능합니다. 같은 시간에 다른 예약이 있어 신청할 수 없습니다.","error");return}if(j&&N.length>=E){n(`이 시설은 최대 ${E}팀까지 동시 사용 가능합니다. 현재 ${N.length}팀이 예약되어 있어 추가 신청이 불가합니다.`,"error");return}const w={purpose:s.purpose,category:s.category,numberOfParticipants:s.numberOfParticipants||1,facilityId:h.id,startDate:s.startDate,endDate:s.endDate,startTime:s.startTime,endTime:s.endTime},D=`booking-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,H={id:D,...w,userId:a.id,userName:a.name,userEmail:a.email,status:"pending",createdAt:new Date};i(d=>[H,...d]),n("대관 신청이 완료되었습니다! 관리자 승인 후 확정됩니다.","success"),l({purpose:"",category:"training",numberOfParticipants:1,startDate:new Date().toISOString().split("T")[0],endDate:new Date().toISOString().split("T")[0],startTime:"09:00",endTime:"10:00",facilityId:""}),console.log("대관 신청 요청 데이터:",w);try{const d=await oe(w);console.log("대관 신청 Firebase 저장 성공:",d),d?.data?.bookingId&&d.data.bookingId!==D&&i(C=>C.map(y=>y.id===D?{...y,id:d.data.bookingId}:y))}catch(d){console.warn("Firebase Function 호출 실패 (사용자는 이미 성공 피드백 받음):",d)}}catch(o){const c=o instanceof Error?o.message:"예약 실패: 알 수 없는 오류";n(c,"error")}finally{S(!1)}},[s,b,n,a,i]);return e.jsxs("div",{className:"max-w-6xl mx-auto p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"체육관 대관 / Gym Booking"}),e.jsx("p",{className:"text-gray-600",children:"체육관 공간을 예약하고 관리하세요 / Book and manage gym spaces"}),x&&e.jsxs("div",{className:"flex items-center gap-2 text-blue-600 mt-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-blue-600"}),e.jsx("span",{className:"text-xs",children:"동기화 중..."})]})]}),e.jsxs("div",{className:"flex items-center gap-2 bg-gray-100 p-1 rounded-lg",children:[e.jsxs("button",{onClick:()=>T("list"),className:`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${v==="list"?"bg-white text-blue-600 shadow-sm":"text-gray-600 hover:text-gray-900"}`,children:[e.jsx(re,{className:"w-4 h-4"}),"목록 / List"]}),e.jsxs("button",{onClick:()=>T("calendar"),className:`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${v==="calendar"?"bg-white text-blue-600 shadow-sm":"text-gray-600 hover:text-gray-900"}`,children:[e.jsx(ne,{className:"w-4 h-4"}),"캘린더 / Calendar"]})]})]}),v==="list"?e.jsx(e.Fragment,{children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border border-gray-100 p-6",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"진행중인 대관 / Active Bookings"}),e.jsxs("div",{className:"space-y-3",children:[k.map(t=>e.jsx(O,{booking:t},t.id)),k.length===0&&e.jsx("p",{className:"text-center text-gray-500 py-10",children:"진행중인 대관 신청이 없습니다."})]})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border border-gray-100 p-6",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"완료된 대관 / Completed Bookings"}),e.jsxs("div",{className:"space-y-3 max-h-96 overflow-y-auto pr-2",children:[$.map(t=>e.jsx(O,{booking:t},t.id)),$.length===0&&e.jsx("p",{className:"text-center text-gray-500 py-10",children:"완료된 대관이 없습니다."})]})]})]})}):e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border border-gray-100 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-900",children:[f.getFullYear(),"년 ",f.getMonth()+1,"월"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>M("prev"),className:"p-2 rounded-lg hover:bg-gray-100 transition-colors",children:e.jsx(le,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>I(new Date),className:"px-4 py-2 text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors",children:"오늘"}),e.jsx("button",{onClick:()=>M("next"),className:"p-2 rounded-lg hover:bg-gray-100 transition-colors",children:e.jsx(ie,{className:"w-5 h-5"})})]})]}),e.jsx("div",{className:"grid grid-cols-7 gap-px mb-2",children:["일","월","화","수","목","금","토"].map(t=>e.jsx("div",{className:"p-2 text-center text-sm font-medium text-gray-500",children:t},t))}),e.jsx("div",{className:"grid grid-cols-7 gap-px bg-gray-200 rounded-lg overflow-hidden",children:B().map((t,o)=>{const c=F(t),u=t.getMonth()===f.getMonth(),h=t.toDateString()===new Date().toDateString();return e.jsxs("div",{className:`bg-white p-2 min-h-[120px] ${u?"text-gray-900":"text-gray-400"} ${h?"bg-blue-50":""}`,children:[e.jsx("div",{className:`text-sm font-medium mb-1 ${h?"text-blue-600":""}`,children:t.getDate()}),e.jsxs("div",{className:"space-y-1",children:[c.slice(0,3).map(m=>e.jsx("div",{className:`text-xs px-2 py-1 rounded text-white text-center truncate ${m.status==="approved"?"bg-green-500":m.status==="pending"?"bg-orange-500":m.status==="rejected"?"bg-red-500":"bg-gray-500"}`,title:`${m.purpose} (${m.startTime}-${m.endTime})`,children:m.purpose},m.id)),c.length>3&&e.jsxs("div",{className:"text-xs text-gray-500 text-center",children:["+",c.length-3," more"]})]})]},o)})}),e.jsxs("div",{className:"flex items-center justify-center gap-6 mt-4 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-green-500 rounded"}),e.jsx("span",{children:"승인됨"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-orange-500 rounded"}),e.jsx("span",{children:"대기중"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-red-500 rounded"}),e.jsx("span",{children:"거절됨"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-gray-500 rounded"}),e.jsx("span",{children:"완료됨"})]})]})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border border-gray-100 p-6",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-4",children:"신규 대관 신청"}),e.jsxs("form",{onSubmit:P,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"대관 목적"}),e.jsx("input",{type:"text",className:"w-full p-3 border border-gray-200 rounded-xl",value:s.purpose||"",onChange:t=>l({...s,purpose:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"분류"}),e.jsxs("select",{className:"w-full p-3 border border-gray-200 rounded-xl bg-white",value:s.category,onChange:t=>l({...s,category:t.target.value}),children:[e.jsx("option",{value:"training",children:"훈련"}),e.jsx("option",{value:"class",children:"수업"}),e.jsx("option",{value:"event",children:"행사"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"시설 선택"}),e.jsxs("select",{className:"w-full p-3 border border-gray-200 rounded-xl bg-white",value:s.facilityId||"",onChange:t=>l({...s,facilityId:t.target.value}),children:[e.jsx("option",{value:"",children:"시설을 선택해 주세요"}),b.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsx("div",{})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"시작일"}),e.jsx("input",{type:"date",className:"w-full p-3 border border-gray-200 rounded-xl",value:s.startDate||"",onChange:t=>l({...s,startDate:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"종료일"}),e.jsx("input",{type:"date",className:"w-full p-3 border border-gray-200 rounded-xl",value:s.endDate||"",onChange:t=>l({...s,endDate:t.target.value})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"시작 시간"}),e.jsx("input",{type:"time",className:"w-full p-3 border border-gray-200 rounded-xl",value:s.startTime||"",onChange:t=>l({...s,startTime:t.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"종료 시간"}),e.jsx("input",{type:"time",className:"w-full p-3 border border-gray-200 rounded-xl",value:s.endTime||"",onChange:t=>l({...s,endTime:t.target.value})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"인원"}),e.jsx(de,{value:s.numberOfParticipants||1,onChange:t=>l({...s,numberOfParticipants:t})})]}),e.jsx("div",{className:"flex items-end",children:e.jsx("button",{type:"submit",disabled:p,className:`w-full md:w-auto px-4 py-3 rounded-xl font-medium transition-all duration-200 ${p?"bg-gray-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700 text-white"}`,children:p?e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"신청 중..."]}):"대관 신청"})})]})]})]})]})};export{je as default};
