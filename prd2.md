체육관 시설 대관 시스템 제품 요구사항 명세서 (PRD)
1. 개요
프로젝트명: FlexSpace Pro - 시설 대관 시스템

목표: 사용자가 온라인으로 체육관 내 여러 시설(농구장, 풋살장 등)의 대관 가능 시간을 확인하고, 중복 없이 예약을 신청할 수 있는 시스템을 구축한다.

2. 사용자 종류 및 역할
일반 사용자 (User): 시스템을 통해 시설 대관을 신청하고 자신의 예약 현황을 관리한다.

관리자 (Admin): 모든 사용자의 대관 신청을 관리(승인/거절)하고, 시스템 설정을 변경할 수 있다.

3. 핵심 기능 요구사항
3.1. 시설 대관 신청 (Create Booking)
사용자는 원하는 시설과 날짜, 시간을 선택하여 대관을 신청할 수 있다.

시스템은 신청된 시간이 다른 예약과 겹치지 않는지 자동으로 확인해야 한다.

대관 목적(Purpose), 종류(Category)를 필수로 입력해야 한다.

신청이 완료되면 '승인 대기(pending)' 상태가 된다.

3.2. 예약 현황 조회
사용자는 자신의 대시보드에서 예약 목록과 각 예약의 상태('승인 대기', '승인됨', '거절됨' 등)를 확인할 수 있다.

관리자는 모든 사용자의 예약 목록을 조회하고 관리할 수 있다.

3.3. 예약 중복 방지
동일 시설, 동일 시간 중복 불가: 하나의 시설은 특정 시간에 오직 하나의 예약만 '승인됨(approved)' 상태를 가질 수 있다.

버퍼 시간(Buffer Time): 각 예약의 전후로 설정된 정리 시간(버퍼) 동안에는 다른 예약을 신청할 수 없어야 한다.

동시 요청 처리: 여러 사용자가 거의 동시에 같은 시간을 신청하더라도, 시스템은 단 하나의 요청만 처리하고 나머지는 거절해야 한다.

3.4. (확장 기능) 다중 수용 시설 예약
요가실, 헬스장 등 여러 명이 동시에 사용할 수 있는 시설의 경우, 최대 수용 인원(Capacity)을 초과하지 않는 선에서 중복 예약을 허용해야 한다.

4. 비기능적 요구사항
성능: 사용자가 예약 가능 시간을 조회할 때 3초 이내에 응답해야 한다.

보안: 사용자는 자신의 예약 정보만 조회/수정할 수 있어야 하며, 관리자 외에는 타인의 정보에 접근할 수 없어야 한다.

안정성: 예약 생성 로직은 데이터 정합성을 100% 보장해야 한다.

2. 더 효과적인 중복 체크 방법 5가지 제안
기본 원리를 넘어서, 유명 예약/스케줄 관리 프로그램들은 사용자의 편의성과 운영 효율을 높이기 위해 다음과 같은 고도화된 방법을 사용합니다.
① 시간 블록킹 / 그리드(Grid) 방식
마치 구글 캘린더처럼 하루를 30분 또는 1시간 단위의 작은 블록으로 나누어 화면에 표시합니다. 예약이 완료된 시간 블록은 다른 색으로 비활성화하여 사용자가 시각적으로 예약 가능한 시간을 즉시 파악하게 만드는 방식입니다.
• 장점: 사용자가 여러 시간을 클릭하며 일일이 가능 여부를 확인할 필요 없이, 한눈에 현황을 파악할 수 있어 매우 직관적입니다.
• 개발 방식: 프론트엔드에서 시간별 그리드를 그리고, 해당 날짜/장소의 예약 데이터를 불러와 이미 예약된 시간 블록의 UI 상태를 'disabled'로 변경합니다.
② 자원/정원(Capacity) 기반 중복 체크
한 장소에 한 팀만 예약하는 것이 아니라, 여러 명/팀이 동시에 사용할 수 있는 경우(예: 요가 클래스, 헬스장, 수영장 레인)에 사용됩니다.
• 장점: 공간의 활용도를 극대화할 수 있습니다. 예를 들어 '요가실 (최대 20명)'에 15명이 예약했다면, 5명의 예약을 더 받을 수 있습니다.
• 개발 방식: 예약 데이터에 numberOfParticipants(참여 인원) 필드를 추가합니다. 새로운 예약 요청이 오면, 해당 시간대에 이미 잡혀있는 모든 예약의 numberOfParticipants총합과 새로운 예약의 인원을 더한 값이 장소의 maxCapacity(최대 정원)를 초과하는지 확인합니다.
③ 버퍼 시간(Buffer Time) 자동 설정
A팀의 대관이 오후 4시에 끝나고, B팀의 대관이 정확히 4시에 시작되면 청소나 준비 시간이 없어 문제가 발생합니다. 이를 시스템적으로 방지하는 기능입니다.
• 장점: 운영 품질을 높이고 예약자 간의 마찰을 줄일 수 있습니다.
• 개발 방식: 오후 2시-4시 예약이 생성되면, 시스템은 자동으로 예약 시간 앞뒤로 15분씩(오후 1:45-2:00, 4:00-4:15)을 '예약 불가(버퍼)' 시간으로 함께 설정하여 다른 사람이 예약할 수 없도록 막습니다.
④ 조건부/규칙 기반 예약
단순 시간 중복을 넘어, 체육관의 복잡한 운영 규칙을 시스템에 적용하는 방식입니다.
• 장점: 관리자가 수동으로 처리하던 복잡한 예외 규칙을 자동화하여 업무를 줄입니다.
• 개발 방식: "주말에는 최소 2시간 이상만 예약 가능", "회원 등급에 따라 특정 시간대(Prime Time) 예약 제한" 과 같은 규칙(Rule)을 코드로 구현하여, 예약 요청이 이 규칙에 맞는지 시간 중복 체크와 함께 검사합니다.
⑤ 가예약/선점(Pre-booking) 시스템
사용자가 특정 시간을 선택하고 결제나 정보 입력을 하는 동안 다른 사용자가 해당 시간을 가로채는 것을 방지하는 기능입니다.
• 장점: 사용자의 예약 경험을 크게 향상시키고 이탈을 막습니다.
• 개발 방식: 사용자가 특정 시간을 선택하면, 해당 예약의 상태를 10분간 pending(선점)으로 설정합니다. 다른 사용자가 이 시간대에 접근하면 '다른 사용자가 예약 진행 중'이라고 표시합니다. 10분 내에 예약이 완료되면 confirmed(확정)으로 변경하고, 시간이 지나면 pending상태를 자동으로 해제하여 다른 사람이 예약할 수 있게 합니다.

#Cloud Functions
현재 Firebase를 사용하고 계시므로, 중복 체크 로직을 구현하는 가장 효과적인 방법을 알려드리겠습니다.
데이터 구조 (Firestore Collection)
먼저 reservations라는 컬렉션을 다음과 같이 구성합니다.
reservations (collection)
  └─ reservation_doc_1 (document)
     ├─ locationId: "gym_A_court" (참조하는 장소의 고유 ID)
     ├─ userId: "firebase_auth_uid" (예약한 사용자의 인증 ID)
     ├─ startTime: Timestamp(September 1, 2025 at 2:00:00 PM UTC+9)
     ├─ endTime: Timestamp(September 1, 2025 at 4:00:00 PM UTC+9)
     └─ status: "confirmed"

• 중요: startTime과 endTime은 반드시 Firebase의 Timestamp타입으로 저장해야 시간 비교 쿼리가 가능합니다.
중복 체크 로직 (Cloud Functions 사용을 강력 추천)
새로운 예약(newStartnewEnd)이 기존 예약(existingStartexistingEnd)과 겹치는지 확인하는 핵심 로직은 다음과 같습니다.
newStart < existingEndAND newEnd > existingStart
위 조건이 참이면 두 시간대는 겹치는 것입니다. 하지만 Firestore 쿼리에는 두 개의 다른 필드(startTime, endTime)에 대해 범위 비교(<, >)를 동시에 사용할 수 없는 제약이 있습니다.
이 문제를 해결하는 가장 안정적이고 전문적인 방법은 Firebase Cloud Functions를 사용하는 것입니다.
개발 흐름:
1. 클라이언트 (웹/앱): 사용자가 장소와 시간을 선택하고 '예약하기' 버튼을 누릅니다.
2. 클라이언트는 예약 정보를 담아 직접 DB에 쓰는 것이 아니라, Cloud Function을 호출합니다.
3. 17